name: Rollback Dev (switch CloudFront origin path)

on:
  workflow_dispatch:
    inputs:
      target_version:
        description: "Rollback target (e.g., v1.2.3 or a commit SHA folder name)"
        required: true
        type: string

concurrency:
  group: dev-rollback
  cancel-in-progress: false

permissions:
  contents: read
  id-token: write

jobs:
  rollback_dev:
    name: Rollback Dev to target version
    runs-on: ubuntu-latest
    environment: dev

    steps:
      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ vars.AWS_ROLE_ARN_DEV }}
          aws-region: ${{ vars.AWS_REGION }}

      - name: Validate target exists in S3 (dev releases folder)
        shell: bash
        run: |
          set -euo pipefail
          TARGET="${{ inputs.target_version }}"
          echo "Validating dev release exists: s3://${{ vars.DEV_BUCKET }}/releases/${TARGET}/"
          aws s3 ls "s3://${{ vars.DEV_BUCKET }}/releases/${TARGET}/index.html" >/dev/null
          aws s3 ls "s3://${{ vars.DEV_BUCKET }}/releases/${TARGET}/assets/" >/dev/null

      - name: Fetch CloudFront config + ETag
        id: cf
        shell: bash
        run: |
          set -euo pipefail
          aws cloudfront get-distribution-config --id "${{ vars.DEV_CF_DIST_ID }}" > cf.json
          ETAG=$(jq -r '.ETag' cf.json)
          ORIGIN_PATH=$(jq -r '.DistributionConfig.Origins.Items[0].OriginPath' cf.json)
          echo "etag=$ETAG" >> "$GITHUB_OUTPUT"
          echo "origin_path=$ORIGIN_PATH" >> "$GITHUB_OUTPUT"
          echo "Current origin path: $ORIGIN_PATH"

      - name: Update CloudFront origin path to target
        shell: bash
        run: |
          set -euo pipefail
          TARGET="${{ inputs.target_version }}"
          NEW_PATH="/releases/${TARGET}"
          echo "Switching origin path to: $NEW_PATH"

          jq ".DistributionConfig.Origins.Items[0].OriginPath = \"${NEW_PATH}\"" cf.json \
            | jq '.DistributionConfig' > updated-config.json

          aws cloudfront update-distribution \
            --id "${{ vars.DEV_CF_DIST_ID }}" \
            --if-match "${{ steps.cf.outputs.etag }}" \
            --distribution-config file://updated-config.json

      - name: Invalidate index.html only
        shell: bash
        run: |
          set -euo pipefail
          aws cloudfront create-invalidation \
            --distribution-id "${{ vars.DEV_CF_DIST_ID }}" \
            --paths "/index.html"

      - name: Update ACTIVE_VERSION.json
        shell: bash
        run: |
          set -euo pipefail
          TARGET="${{ inputs.target_version }}"
          RUN_URL="${GITHUB_SERVER_URL}/${GITHUB_REPOSITORY}/actions/runs/${GITHUB_RUN_ID}"
          TS="$(date -u +"%Y-%m-%dT%H:%M:%SZ")"

          cat > active.json <<EOF
          {
            "env": "dev",
            "active_version": "${TARGET}",
            "rolled_back_at_utc": "${TS}",
            "rolled_back_by": "${GITHUB_ACTOR}",
            "workflow_run_url": "${RUN_URL}"
          }
          EOF

          aws s3 cp active.json "s3://${{ vars.DEV_BUCKET }}/releases/ACTIVE_VERSION.json" \
            --cache-control "no-cache, no-store, must-revalidate" \
            --content-type "application/json"

      - name: Post-rollback smoke (HTTP)
        shell: bash
        run: |
          set -euo pipefail
          URL="${{ vars.DEV_URL }}"
          echo "Smoke testing: ${URL}/index.html"
          curl -fsS "${URL}/index.html" >/dev/null
          echo "OK: index.html reachable"

      - name: Summary
        shell: bash
        run: |
          TARGET="${{ inputs.target_version }}"
          {
            echo "### Dev Rollback Summary"
            echo ""
            echo "- **Target:** ${TARGET}"
            echo "- **URL:** ${{ vars.DEV_URL }}"
            echo "- **Old origin path:** ${{ steps.cf.outputs.origin_path }}"
            echo "- **New origin path:** /releases/${TARGET}"
            echo "- **Run:** ${GITHUB_SERVER_URL}/${GITHUB_REPOSITORY}/actions/runs/${GITHUB_RUN_ID}"
          } >> $GITHUB_STEP_SUMMARY
