name: Release Prod

on:
  workflow_dispatch:
    inputs:
      version:
        description: "Release version (e.g. v1.1.1)"
        required: true
        type: string

concurrency:
  group: production
  cancel-in-progress: false

permissions:
  contents: read
  id-token: write
  actions: read

jobs:
  release_prod:
    name: Production Release
    runs-on: ubuntu-latest
    environment: main

    defaults:
      run:
        working-directory: frontend

    steps:
      - name: Checkout main
        uses: actions/checkout@v4
        with:
          ref: main
          fetch-depth: 0

      - name: Validate version format
        shell: bash
        run: |
          set -euo pipefail
          V="${{ inputs.version }}"
          [[ "$V" =~ ^v[0-9]+\.[0-9]+\.[0-9]+$ ]] || { echo "Invalid version: $V (use vX.Y.Z)"; exit 1; }

      - name: Determine main HEAD SHA
        id: ref
        shell: bash
        run: |
          set -euo pipefail
          SHA="$(git rev-parse HEAD)"
          echo "tag=${{ inputs.version }}" >> "$GITHUB_OUTPUT"
          echo "sha=${SHA}" >> "$GITHUB_OUTPUT"
          echo "Release: ${{ inputs.version }}"
          echo "SHA: ${SHA}"

      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN_PROD }}
          aws-region: ${{ vars.AWS_REGION }}

      - name: Immutability check (fail if release already exists)
        shell: bash
        run: |
          set -euo pipefail
          TAG="${{ steps.ref.outputs.tag }}"
          if aws s3 ls "s3://${{ vars.PROD_BUCKET }}/releases/${TAG}/" >/dev/null 2>&1; then
            echo "Release already exists: s3://${{ vars.PROD_BUCKET }}/releases/${TAG}/"
            exit 1
          fi
          echo "OK: releases/${TAG}/ does not exist"

      - name: Try download artifact from S3 (by main HEAD SHA)
        id: artifact
        shell: bash
        run: |
          set -euo pipefail
          SHA="${{ steps.ref.outputs.sha }}"
          ZIP_KEY="s3://${{ vars.ARTIFACT_BUCKET }}/frontend/${SHA}.zip"
          MANIFEST_KEY="s3://${{ vars.ARTIFACT_BUCKET }}/frontend/${SHA}.manifest.json"

          echo "zip_key=${ZIP_KEY}" >> "$GITHUB_OUTPUT"
          echo "manifest_key=${MANIFEST_KEY}" >> "$GITHUB_OUTPUT"

          echo "Checking artifact: ${ZIP_KEY}"
          if aws s3 ls "${ZIP_KEY}" >/dev/null 2>&1; then
            echo "exists=true" >> "$GITHUB_OUTPUT"
            echo "Artifact exists."
          else
            echo "exists=false" >> "$GITHUB_OUTPUT"
            echo "Artifact missing for SHA=${SHA} (will build+publish now)."
          fi


      - name: Setup Node (only if artifact missing)
        if: steps.artifact.outputs.exists == 'false'
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
          cache-dependency-path: frontend/package-lock.json

      - name: Install deps (only if artifact missing)
        if: steps.artifact.outputs.exists == 'false'
        run: npm ci

      - name: Build frontend (only if artifact missing)
        if: steps.artifact.outputs.exists == 'false'
        run: npm run build

      - name: Package build as zip (only if artifact missing)
        if: steps.artifact.outputs.exists == 'false'
        shell: bash
        run: |
          set -euo pipefail
          BUILD_DIR="build"   # change to "dist" if Vite
          test -f "${BUILD_DIR}/index.html"

          rm -f frontend-build.zip
          (cd "${BUILD_DIR}" && zip -r "../frontend-build.zip" .)
          ls -la frontend-build.zip

      - name: Create + upload manifest (only if artifact missing)
        if: steps.artifact.outputs.exists == 'false'
        shell: bash
        run: |
          set -euo pipefail
          VERSION="$(node -p "require('./package.json').version" 2>/dev/null || echo '0.0.0')"
          SHA="${{ steps.ref.outputs.sha }}"
          RUN_URL="${GITHUB_SERVER_URL}/${GITHUB_REPOSITORY}/actions/runs/${GITHUB_RUN_ID}"
          TS="$(date -u +"%Y-%m-%dT%H:%M:%SZ")"

          cat > manifest.json <<EOF
          {
            "env": "main",
            "version": "${VERSION}",
            "sha": "${SHA}",
            "run_url": "${RUN_URL}",
            "build_time_utc": "${TS}"
          }
          EOF

          aws s3 cp frontend-build.zip "${{ steps.artifact.outputs.zip_key }}"
          aws s3 cp manifest.json "${{ steps.artifact.outputs.manifest_key }}" || true

      - name: Download artifact zip (guaranteed now)
        shell: bash
        run: |
          set -euo pipefail
          aws s3 cp "${{ steps.artifact.outputs.zip_key }}" ./frontend-build.zip
          aws s3 cp "${{ steps.artifact.outputs.manifest_key }}" ./manifest.json || true

      - name: Unzip build
        shell: bash
        run: |
            set -euo pipefail
            rm -rf ../build_out
            mkdir -p ../build_out
            ls -la .
            test -f ./frontend-build.zip
            unzip -q ./frontend-build.zip -d ../build_out
            test -f ../build_out/index.html


      - name: Upload to Prod S3 immutable release folder
        shell: bash
        run: |
          set -euo pipefail
          TAG="${{ steps.ref.outputs.tag }}"
          aws s3 sync ../build_out/ "s3://${{ vars.PROD_BUCKET }}/releases/${TAG}/" --delete

      - name: Pre-switch smoke (HTTP fetch release path)
        shell: bash
        run: |
          set -euo pipefail
          TAG="${{ steps.ref.outputs.tag }}"
          URL="${{ vars.PROD_URL }}"
          [[ "$URL" =~ ^https?:// ]] || URL="https://${URL}"
          echo "Pre-switch smoke: ${URL}/releases/${TAG}/index.html"
          curl -fsS "${URL}/releases/${TAG}/index.html" >/dev/null

      - name: Fetch CloudFront config + ETag
        id: cf
        shell: bash
        run: |
          set -euo pipefail
          aws cloudfront get-distribution-config --id "${{ vars.PROD_CF_DIST_ID }}" > /tmp/cf.json
          echo "etag=$(jq -r '.ETag' /tmp/cf.json)" >> "$GITHUB_OUTPUT"
          echo "origin_path=$(jq -r '.DistributionConfig.Origins.Items[0].OriginPath' /tmp/cf.json)" >> "$GITHUB_OUTPUT"

      - name: Safe switch (update CloudFront origin path)
        shell: bash
        run: |
          set -euo pipefail
          TAG="${{ steps.ref.outputs.tag }}"
          NEW_PATH="/releases/${TAG}"
          echo "Switching origin path to: ${NEW_PATH}"

          jq ".DistributionConfig.Origins.Items[0].OriginPath = \"${NEW_PATH}\"" /tmp/cf.json \
            | jq '.DistributionConfig' > /tmp/updated-config.json

          aws cloudfront update-distribution \
            --id "${{ vars.PROD_CF_DIST_ID }}" \
            --if-match "${{ steps.cf.outputs.etag }}" \
            --distribution-config file:///tmp/updated-config.json

      - name: Invalidate index.html only
        shell: bash
        run: |
          set -euo pipefail
          aws cloudfront create-invalidation \
            --distribution-id "${{ vars.PROD_CF_DIST_ID }}" \
            --paths "/index.html"

      - name: Update ACTIVE_VERSION.json
        shell: bash
        run: |
          set -euo pipefail
          TAG="${{ steps.ref.outputs.tag }}"
          SHA="${{ steps.ref.outputs.sha }}"
          RUN_URL="${GITHUB_SERVER_URL}/${GITHUB_REPOSITORY}/actions/runs/${GITHUB_RUN_ID}"
          TS="$(date -u +"%Y-%m-%dT%H:%M:%SZ")"

          cat > /tmp/active.json <<EOF
          {
            "env": "production",
            "active_version": "${TAG}",
            "sha": "${SHA}",
            "deployed_at_utc": "${TS}",
            "deployed_by": "${GITHUB_ACTOR}",
            "workflow_run_url": "${RUN_URL}"
          }
          EOF

          aws s3 cp /tmp/active.json "s3://${{ vars.PROD_BUCKET }}/releases/ACTIVE_VERSION.json" \
            --cache-control "no-cache, no-store, must-revalidate" \
            --content-type "application/json"

      - name: Post-deploy smoke (HTTP)
        shell: bash
        run: |
          set -euo pipefail
          URL="${{ vars.PROD_URL }}"
          [[ "$URL" =~ ^https?:// ]] || URL="https://${URL}"
          echo "Post-deploy smoke: ${URL}/index.html"
          curl -fsS "${URL}/index.html" >/dev/null

      - name: Output summary
        shell: bash
        run: |
          set -euo pipefail
          TAG="${{ steps.ref.outputs.tag }}"
          SHA="${{ steps.ref.outputs.sha }}"
          URL="${{ vars.PROD_URL }}"
          [[ "$URL" =~ ^https?:// ]] || URL="https://${URL}"

          {
            echo "### Production Release Summary"
            echo "- Version: ${TAG}"
            echo "- SHA: ${SHA}"
            echo "- URL: ${URL}"
            echo "- Old origin path: ${{ steps.cf.outputs.origin_path }}"
            echo "- New origin path: /releases/${TAG}"
            echo "- Artifact: s3://${{ vars.ARTIFACT_BUCKET }}/frontend/${SHA}.zip"
            echo "- Artifact existed: ${{ steps.artifact.outputs.exists }}"
          } >> $GITHUB_STEP_SUMMARY
